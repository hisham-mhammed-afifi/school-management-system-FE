# Backend API Reference

> Auto-generated by Backend Expert Agent on 2026-02-18
> Source: D:\me\school-management-system

## Overview

- **Framework**: Express.js (Node.js) with TypeScript
- **ORM**: Prisma (PostgreSQL)
- **Validation**: Zod schemas
- **Base URL**: `/api/v1`
- **Auth**: JWT (HS256) with access + refresh tokens
- **Password Hashing**: Argon2id
- **Logging**: Pino (JSON in production, pretty in dev)
- **API Docs**: Swagger UI at `/api-docs`, OpenAPI spec at `/api-docs.json`
- **Health Check**: `GET /health`

## Response Envelope

All responses follow a consistent envelope:

```typescript
// Success - single resource
{ success: true, data: { ...resource } }

// Success - paginated list
{ success: true, data: [...], meta: { page: number, limit: number, total: number, totalPages: number } }

// Success - action
{ success: true, data: { message: string } }

// Error - operational
{ success: false, error: { code: string, message: string } }

// Error - validation (422)
{ success: false, error: { code: "VALIDATION_ERROR", details: [{ path: string, message: string }] } }
```

---

## Authentication

### Login Flow

1. `POST /api/v1/auth/login` with `{ email, password }`
2. Server verifies password with Argon2id
3. Checks account active status and school status (not suspended/archived/expired)
4. Collects all roles and flattens permissions
5. Returns access token (1h) + refresh token (7d)
6. Updates `lastLoginAt`

### Token Structure

```typescript
// Access Token Payload
interface JwtPayload {
  sub: string; // User ID (UUID)
  schoolId: string | null; // null for super admins
  roles: string[]; // Role names e.g. ["school_admin", "teacher"]
  permissions: string[]; // Flattened permission names
  iat: number;
  exp: number;
}

// Refresh Token Payload
interface RefreshPayload {
  sub: string; // User ID
  type: 'refresh';
  iat: number;
  exp: number;
}
```

### JWT Configuration

| Setting              | Default | Env Variable                |
| -------------------- | ------- | --------------------------- |
| Algorithm            | HS256   | -                           |
| Secret               | -       | `JWT_SECRET` (min 32 chars) |
| Access token expiry  | 1h      | `JWT_EXPIRES_IN`            |
| Refresh token expiry | 7d      | `JWT_REFRESH_EXPIRES_IN`    |

### Rate Limiting

| Endpoint                     | Limit       | Window              |
| ---------------------------- | ----------- | ------------------- |
| `POST /auth/login`           | 10 requests | 15 minutes (per IP) |
| `POST /auth/refresh`         | 30 requests | 15 minutes (per IP) |
| `POST /auth/forgot-password` | 10 requests | 15 minutes (per IP) |
| `POST /auth/reset-password`  | 10 requests | 15 minutes (per IP) |

### Roles & Permissions

**Seed Roles** (protected, cannot be modified/deleted):
`super_admin`, `school_admin`, `principal`, `teacher`, `student`, `guardian`, `accountant`

Custom roles can be created per school. Permissions are assigned to roles and flattened into the JWT.

### Super Admin Header

Super admins (`schoolId = null`) must pass `X-School-Id` header for school-scoped operations.

### Subscription Plan Feature Gates

| Feature                 | Minimum Plan |
| ----------------------- | ------------ |
| `report_cards`          | basic        |
| `fee_management`        | basic        |
| `auto_scheduling`       | premium      |
| `per_lesson_attendance` | premium      |
| `online_payment`        | premium      |
| `sms_notifications`     | premium      |
| `custom_roles`          | premium      |
| `audit_logs`            | premium      |
| `api_access`            | enterprise   |

Plan hierarchy: `free` < `basic` < `premium` < `enterprise`

---

## API Endpoints

### Auth

#### Login

- **Method**: POST
- **URL**: `/api/v1/auth/login`
- **Auth**: Public (rate limited: 10/15min)
- **Request**:
  ```typescript
  interface LoginInput {
    email: string; // valid email, max 255
    password: string; // min 1 char
  }
  ```
- **Response**:
  ```typescript
  interface LoginResponse {
    accessToken: string;
    refreshToken: string;
    user: {
      id: string;
      email: string;
      roles: string[];
      permissions: string[];
      schoolId: string | null;
    };
  }
  ```

#### Refresh Token

- **Method**: POST
- **URL**: `/api/v1/auth/refresh`
- **Auth**: Public (rate limited: 30/15min)
- **Request**:
  ```typescript
  interface RefreshTokenInput {
    refreshToken: string;
  }
  ```
- **Response**: `{ accessToken: string }`

#### Forgot Password

- **Method**: POST
- **URL**: `/api/v1/auth/forgot-password`
- **Auth**: Public (rate limited)
- **Request**: `{ email: string }`
- **Response**: Always returns `{ message: "If the email exists, a reset link has been sent" }` (prevents email enumeration)

#### Reset Password

- **Method**: POST
- **URL**: `/api/v1/auth/reset-password`
- **Auth**: Public (rate limited)
- **Request**:
  ```typescript
  interface ResetPasswordInput {
    token: string; // reset token from email
    newPassword: string; // 8-128 chars
  }
  ```

#### Logout

- **Method**: POST
- **URL**: `/api/v1/auth/logout`
- **Auth**: Required
- **Response**: `{ message: "Logged out successfully" }` (stateless - client discards tokens)

#### Get Current User

- **Method**: GET
- **URL**: `/api/v1/auth/me`
- **Auth**: Required
- **Response**: User profile with linked entities (teacher/student/guardian)

#### Update Profile

- **Method**: PATCH
- **URL**: `/api/v1/auth/me`
- **Auth**: Required
- **Request**:
  ```typescript
  interface UpdateProfileInput {
    phone?: string; // max 20
    currentPassword?: string;
    newPassword?: string; // 8-128, requires currentPassword
  }
  ```

---

### Schools (Platform Admin)

#### Create School

- **Method**: POST
- **URL**: `/api/v1/platform/schools`
- **Auth**: Required | Permission: platform admin
- **Request**:
  ```typescript
  interface CreateSchoolInput {
    name: string; // 1-255
    code: string; // 1-50, alphanumeric with hyphens, unique
    timezone: string; // 1-50
    defaultLocale?: string; // max 10, default "en"
    currency?: string; // exactly 3 chars, default "USD"
    country?: string; // max 100
    city?: string; // max 100
    address?: string;
    phone?: string; // max 20
    email?: string; // valid email, max 255
    website?: string; // valid URL, max 255
    subscriptionPlan: 'free' | 'basic' | 'premium' | 'enterprise';
  }
  ```
- **Response** (201):
  ```typescript
  interface SchoolResponse {
    id: string;
    name: string;
    code: string;
    logoUrl: string | null;
    timezone: string;
    defaultLocale: string;
    currency: string;
    country: string | null;
    city: string | null;
    address: string | null;
    phone: string | null;
    email: string | null;
    website: string | null;
    subscriptionPlan: 'free' | 'basic' | 'premium' | 'enterprise';
    subscriptionExpiresAt: string | null;
    status: 'active' | 'suspended' | 'archived';
    createdAt: string;
    updatedAt: string;
  }
  ```

#### List Schools

- **Method**: GET
- **URL**: `/api/v1/platform/schools`
- **Auth**: Required | Platform admin
- **Query Params**:
  ```typescript
  interface ListSchoolsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'name' | 'code'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
    status?: 'active' | 'suspended' | 'archived';
    plan?: 'free' | 'basic' | 'premium' | 'enterprise';
    search?: string; // max 255
  }
  ```

#### Get School

- **Method**: GET
- **URL**: `/api/v1/platform/schools/:id`
- **Auth**: Required | Platform admin

#### Update School

- **Method**: PATCH
- **URL**: `/api/v1/platform/schools/:id`
- **Auth**: Required | Platform admin
- **Request**:
  ```typescript
  interface UpdateSchoolInput {
    name?: string;
    logoUrl?: string; // valid URL
    timezone?: string;
    defaultLocale?: string;
    currency?: string;
    country?: string;
    city?: string;
    address?: string;
    phone?: string;
    email?: string;
    website?: string;
    subscriptionPlan?: 'free' | 'basic' | 'premium' | 'enterprise';
    subscriptionExpiresAt?: string; // date
    status?: 'active' | 'suspended' | 'archived';
  }
  ```

#### Suspend School

- **Method**: POST
- **URL**: `/api/v1/platform/schools/:id/suspend`
- **Auth**: Required | Platform admin

#### Reactivate School

- **Method**: POST
- **URL**: `/api/v1/platform/schools/:id/reactivate`
- **Auth**: Required | Platform admin

---

### School Profile (School Admin)

#### Get Own School Profile

- **Method**: GET
- **URL**: `/api/v1/school/profile`
- **Auth**: Required

#### Update Own School Profile

- **Method**: PATCH
- **URL**: `/api/v1/school/profile`
- **Auth**: Required
- **Request**:
  ```typescript
  interface UpdateSchoolProfileInput {
    name?: string; // 1-255
    logoUrl?: string; // valid URL
    address?: string;
    phone?: string; // max 20
    email?: string; // valid email, max 255
    website?: string; // valid URL, max 255
  }
  ```

---

### Users

#### List Users

- **Method**: GET
- **URL**: `/api/v1/users`
- **Auth**: Required | Permission: `users.list`
- **Query Params**:
  ```typescript
  interface ListUsersQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'email' | 'lastLoginAt'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
    roleId?: string; // UUID
    isActive?: boolean;
    search?: string; // max 255
  }
  ```
- **Response**: Formatted user objects:
  ```typescript
  interface UserResponse {
    id: string;
    email: string;
    phone: string | null;
    isActive: boolean;
    lastLoginAt: string | null;
    createdAt: string;
    updatedAt: string;
    roles: Array<{
      roleId: string;
      roleName: string;
      schoolId: string | null;
      schoolName: string | null;
    }>;
  }
  ```

#### Create User

- **Method**: POST
- **URL**: `/api/v1/users`
- **Auth**: Required | Permission: `users.create`
- **Request**:
  ```typescript
  interface CreateUserInput {
    email: string; // valid email, max 255, unique
    phone?: string; // max 20
    password: string; // 8-128
    teacherId?: string; // UUID - link to teacher
    studentId?: string; // UUID - link to student
    guardianId?: string; // UUID - link to guardian
    roleIds: string[]; // UUID array, min 1
    // Validation: at most ONE of teacherId/studentId/guardianId
  }
  ```

#### Get User

- **Method**: GET
- **URL**: `/api/v1/users/:id`
- **Auth**: Required | Permission: `users.read`

#### Update User

- **Method**: PATCH
- **URL**: `/api/v1/users/:id`
- **Auth**: Required | Permission: `users.update`
- **Request**:
  ```typescript
  interface UpdateUserInput {
    email?: string; // valid email, max 255
    phone?: string; // max 20
    isActive?: boolean;
  }
  ```

#### Deactivate User

- **Method**: DELETE
- **URL**: `/api/v1/users/:id`
- **Auth**: Required | Permission: `users.delete`
- **Response**: 204 (sets `isActive = false`, not a hard delete)

#### Assign Role to User

- **Method**: POST
- **URL**: `/api/v1/users/:id/roles`
- **Auth**: Required | Permission: `users.update`
- **Request**:
  ```typescript
  interface AssignRoleInput {
    roleId: string; // UUID
    schoolId?: string; // UUID
  }
  ```

#### Remove Role from User

- **Method**: DELETE
- **URL**: `/api/v1/users/:id/roles/:roleId`
- **Auth**: Required | Permission: `users.update`
- **Query Params**: `?schoolId=uuid` (optional)

---

### Roles

#### List Roles

- **Method**: GET
- **URL**: `/api/v1/roles`
- **Auth**: Required | Permission: `roles.list`
- **Query Params**:
  ```typescript
  interface ListRolesQuery {
    page?: number; // default 1
    limit?: number; // default 20
    search?: string; // max 255
  }
  ```

#### Create Role

- **Method**: POST
- **URL**: `/api/v1/roles`
- **Auth**: Required | Permission: `roles.create`
- **Request**: `{ name: string }` (1-100, cannot use reserved seed role names)
- **Response**: 201

#### Get Role

- **Method**: GET
- **URL**: `/api/v1/roles/:id`
- **Auth**: Required | Permission: `roles.read`

#### Update Role

- **Method**: PATCH
- **URL**: `/api/v1/roles/:id`
- **Auth**: Required | Permission: `roles.update`
- **Request**: `{ name: string }` (1-100)
- **Business Rules**: Cannot modify seed roles

#### Delete Role

- **Method**: DELETE
- **URL**: `/api/v1/roles/:id`
- **Auth**: Required | Permission: `roles.delete`
- **Response**: 204
- **Business Rules**: Cannot delete seed roles or roles with assigned users

#### Set Role Permissions

- **Method**: PUT
- **URL**: `/api/v1/roles/:id/permissions`
- **Auth**: Required | Permission: `roles.update`
- **Request**: `{ permissionIds: string[] }` (UUID array)

---

### Permissions

#### List All Permissions

- **Method**: GET
- **URL**: `/api/v1/permissions`
- **Auth**: Required | Permission: `roles.read`
- **Response**: Array of all available permissions
  ```typescript
  interface Permission {
    id: string;
    module: string; // e.g. "users", "students"
    action: string; // e.g. "list", "create", "read", "update", "delete"
    name: string; // e.g. "users.list" (unique)
  }
  ```

---

### Academic Years

#### List Academic Years

- **Method**: GET
- **URL**: `/api/v1/academic-years`
- **Auth**: Required | Permission: `academic-years.list`
- **Query Params**:
  ```typescript
  interface ListAcademicYearsQuery {
    page?: number; // default 1
    limit?: number; // 1-100, default 20
    isActive?: boolean;
  }
  ```

#### Create Academic Year

- **Method**: POST
- **URL**: `/api/v1/academic-years`
- **Auth**: Required | Permission: `academic-years.create`
- **Request**:
  ```typescript
  interface CreateAcademicYearInput {
    name: string; // 1-50
    startDate: string; // date
    endDate: string; // date, must be after startDate
  }
  ```
- **Response**: 201
- **Business Rules**: No overlapping date ranges allowed

#### Get Academic Year

- **Method**: GET
- **URL**: `/api/v1/academic-years/:id`
- **Auth**: Required | Permission: `academic-years.read`

#### Update Academic Year

- **Method**: PATCH
- **URL**: `/api/v1/academic-years/:id`
- **Auth**: Required | Permission: `academic-years.update`

#### Delete Academic Year

- **Method**: DELETE
- **URL**: `/api/v1/academic-years/:id`
- **Auth**: Required | Permission: `academic-years.delete`
- **Response**: 204
- **Business Rules**: Cannot delete if has dependents (terms, class sections, etc.)

#### Activate Academic Year

- **Method**: POST
- **URL**: `/api/v1/academic-years/:id/activate`
- **Auth**: Required | Permission: `academic-years.update`
- **Business Rules**: Deactivates any currently active year, activates this one

---

### Terms

#### List Terms by Academic Year

- **Method**: GET
- **URL**: `/api/v1/academic-years/:yearId/terms`
- **Auth**: Required | Permission: `terms.list`

#### Create Term

- **Method**: POST
- **URL**: `/api/v1/academic-years/:yearId/terms`
- **Auth**: Required | Permission: `terms.create`
- **Request**:
  ```typescript
  interface CreateTermInput {
    name: string; // 1-100
    startDate: string; // date, must be within academic year
    endDate: string; // date, must be after startDate
    orderIndex: number; // positive int
  }
  ```
- **Response**: 201
- **Business Rules**: Dates must fall within parent academic year; no term overlap

#### Update Term

- **Method**: PATCH
- **URL**: `/api/v1/terms/:id`
- **Auth**: Required | Permission: `terms.update`

#### Delete Term

- **Method**: DELETE
- **URL**: `/api/v1/terms/:id`
- **Auth**: Required | Permission: `terms.delete`
- **Response**: 204

---

### Departments

#### List Departments

- **Method**: GET
- **URL**: `/api/v1/departments`
- **Auth**: Required | Permission: `departments.list`
- **Query Params**:
  ```typescript
  interface ListDepartmentsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    search?: string; // max 255
  }
  ```

#### Create Department

- **Method**: POST
- **URL**: `/api/v1/departments`
- **Auth**: Required | Permission: `departments.create`
- **Request**:
  ```typescript
  interface CreateDepartmentInput {
    name: string; // 1-100
    headTeacherId?: string; // UUID
  }
  ```
- **Response**: 201

#### Get Department

- **Method**: GET
- **URL**: `/api/v1/departments/:id`
- **Auth**: Required | Permission: `departments.read`

#### Update Department

- **Method**: PATCH
- **URL**: `/api/v1/departments/:id`
- **Auth**: Required | Permission: `departments.update`
- **Request**:
  ```typescript
  interface UpdateDepartmentInput {
    name?: string; // 1-100
    headTeacherId?: string | null; // UUID or null to clear
  }
  ```

#### Delete Department

- **Method**: DELETE
- **URL**: `/api/v1/departments/:id`
- **Auth**: Required | Permission: `departments.delete`
- **Response**: 204

---

### Grades

#### List Grades

- **Method**: GET
- **URL**: `/api/v1/grades`
- **Auth**: Required | Permission: `grades.list`
- **Query Params**:
  ```typescript
  interface ListGradesQuery {
    page?: number; // default 1
    limit?: number; // 1-100, default 50
  }
  ```

#### Create Grade

- **Method**: POST
- **URL**: `/api/v1/grades`
- **Auth**: Required | Permission: `grades.create`
- **Request**:
  ```typescript
  interface CreateGradeInput {
    name: string; // 1-50
    levelOrder: number; // positive int, unique per school
  }
  ```
- **Response**: 201

#### Get Grade

- **Method**: GET
- **URL**: `/api/v1/grades/:id`
- **Auth**: Required | Permission: `grades.read`

#### Update Grade

- **Method**: PATCH
- **URL**: `/api/v1/grades/:id`
- **Auth**: Required | Permission: `grades.update`

#### Delete Grade

- **Method**: DELETE
- **URL**: `/api/v1/grades/:id`
- **Auth**: Required | Permission: `grades.delete`
- **Response**: 204
- **Business Rules**: Cannot delete if has dependents

---

### Subjects

#### List Subjects

- **Method**: GET
- **URL**: `/api/v1/subjects`
- **Auth**: Required | Permission: `subjects.list`
- **Query Params**:
  ```typescript
  interface ListSubjectsQuery {
    page?: number; // default 1
    limit?: number; // 1-100, default 50
    search?: string; // max 255
    gradeId?: string; // UUID - filter by grade
  }
  ```

#### Create Subject

- **Method**: POST
- **URL**: `/api/v1/subjects`
- **Auth**: Required | Permission: `subjects.create`
- **Request**:
  ```typescript
  interface CreateSubjectInput {
    name: string; // 1-100
    code: string; // 1-20, unique per school
    isLab?: boolean; // default false
    isElective?: boolean; // default false
  }
  ```
- **Response**: 201

#### Get Subject

- **Method**: GET
- **URL**: `/api/v1/subjects/:id`
- **Auth**: Required | Permission: `subjects.read`

#### Update Subject

- **Method**: PATCH
- **URL**: `/api/v1/subjects/:id`
- **Auth**: Required | Permission: `subjects.update`

#### Delete Subject

- **Method**: DELETE
- **URL**: `/api/v1/subjects/:id`
- **Auth**: Required | Permission: `subjects.delete`
- **Response**: 204

#### Set Subject Grades

- **Method**: PUT
- **URL**: `/api/v1/subjects/:subjectId/grades`
- **Auth**: Required | Permission: `subjects.update`
- **Request**: `{ gradeIds: string[] }` (UUID array)

#### Get Subjects by Grade

- **Method**: GET
- **URL**: `/api/v1/grades/:gradeId/subjects`
- **Auth**: Required | Permission: `subjects.list`

---

### Class Sections

#### List Class Sections

- **Method**: GET
- **URL**: `/api/v1/class-sections`
- **Auth**: Required | Permission: `class-sections.list`
- **Query Params**:
  ```typescript
  interface ListClassSectionsQuery {
    page?: number; // default 1
    limit?: number; // 1-100, default 50
    academicYearId?: string; // UUID
    gradeId?: string; // UUID
  }
  ```

#### Create Class Section

- **Method**: POST
- **URL**: `/api/v1/class-sections`
- **Auth**: Required | Permission: `class-sections.create`
- **Request**:
  ```typescript
  interface CreateClassSectionInput {
    academicYearId: string; // UUID
    gradeId: string; // UUID
    name: string; // 1-20
    capacity: number; // positive int
    homeroomTeacherId?: string; // UUID
  }
  ```
- **Response**: 201

#### Get Class Section

- **Method**: GET
- **URL**: `/api/v1/class-sections/:id`
- **Auth**: Required | Permission: `class-sections.read`

#### Update Class Section

- **Method**: PATCH
- **URL**: `/api/v1/class-sections/:id`
- **Auth**: Required | Permission: `class-sections.update`
- **Request**:
  ```typescript
  interface UpdateClassSectionInput {
    name?: string; // 1-20
    capacity?: number; // positive int
    homeroomTeacherId?: string | null; // UUID or null to clear
  }
  ```

#### Delete Class Section

- **Method**: DELETE
- **URL**: `/api/v1/class-sections/:id`
- **Auth**: Required | Permission: `class-sections.delete`
- **Response**: 204

#### Get Section Requirements

- **Method**: GET
- **URL**: `/api/v1/class-sections/:sectionId/requirements`
- **Auth**: Required | Permission: `class-sections.read`

#### Set Section Requirements

- **Method**: PUT
- **URL**: `/api/v1/class-sections/:sectionId/requirements`
- **Auth**: Required | Permission: `class-sections.update`
- **Request**:
  ```typescript
  interface SetRequirementsInput {
    requirements: Array<{
      subjectId: string; // UUID
      weeklyLessonsRequired: number; // positive int
    }>;
  }
  ```

---

### Students

#### List Students

- **Method**: GET
- **URL**: `/api/v1/students`
- **Auth**: Required | Permission: `students.list`
- **Query Params**:
  ```typescript
  interface ListStudentsQuery {
    page?: number; // default 1
    limit?: number; // 1-100, default 20
    sortBy?: 'createdAt' | 'firstName' | 'lastName' | 'studentCode'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
    status?: 'active' | 'graduated' | 'withdrawn' | 'suspended' | 'transferred';
    gradeId?: string; // UUID
    classSectionId?: string; // UUID
    search?: string; // max 255
  }
  ```

#### Create Student

- **Method**: POST
- **URL**: `/api/v1/students`
- **Auth**: Required | Permission: `students.create`
- **Request**:
  ```typescript
  interface CreateStudentInput {
    studentCode: string; // 1-30, unique per school
    firstName: string; // 1-100
    lastName: string; // 1-100
    dateOfBirth: string; // date
    gender: 'male' | 'female';
    nationalId?: string; // max 30
    nationality?: string; // max 50
    religion?: string; // max 50
    bloodType?: 'A_POS' | 'A_NEG' | 'B_POS' | 'B_NEG' | 'AB_POS' | 'AB_NEG' | 'O_POS' | 'O_NEG';
    address?: string;
    phone?: string; // max 20
    email?: string; // valid email, max 255
    photoUrl?: string; // valid URL
    medicalNotes?: string;
    admissionDate: string; // date
  }
  ```
- **Response**: 201

#### Get Student

- **Method**: GET
- **URL**: `/api/v1/students/:id`
- **Auth**: Required | Permission: `students.read`

#### Update Student

- **Method**: PATCH
- **URL**: `/api/v1/students/:id`
- **Auth**: Required | Permission: `students.update`
- **Request**:
  ```typescript
  interface UpdateStudentInput {
    firstName?: string;
    lastName?: string;
    dateOfBirth?: string;
    gender?: 'male' | 'female';
    nationalId?: string | null;
    nationality?: string | null;
    religion?: string | null;
    bloodType?:
      | 'A_POS'
      | 'A_NEG'
      | 'B_POS'
      | 'B_NEG'
      | 'AB_POS'
      | 'AB_NEG'
      | 'O_POS'
      | 'O_NEG'
      | null;
    address?: string | null;
    phone?: string | null;
    email?: string | null;
    photoUrl?: string | null;
    medicalNotes?: string | null;
    status?: 'active' | 'graduated' | 'withdrawn' | 'suspended' | 'transferred';
  }
  ```
- **Business Rules**: Status transitions are validated (finite state machine)

#### Delete Student

- **Method**: DELETE
- **URL**: `/api/v1/students/:id`
- **Auth**: Required | Permission: `students.delete`
- **Response**: 204 (soft delete - sets `deletedAt`)

---

### Teachers

#### List Teachers

- **Method**: GET
- **URL**: `/api/v1/teachers`
- **Auth**: Required | Permission: `teachers.list`
- **Query Params**:
  ```typescript
  interface ListTeachersQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'firstName' | 'lastName' | 'teacherCode'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
    status?: 'active' | 'on_leave' | 'resigned' | 'terminated';
    departmentId?: string; // UUID
    search?: string; // max 255
  }
  ```

#### Create Teacher

- **Method**: POST
- **URL**: `/api/v1/teachers`
- **Auth**: Required | Permission: `teachers.create`
- **Request**:
  ```typescript
  interface CreateTeacherInput {
    teacherCode: string; // 1-30, unique per school
    firstName: string; // 1-100
    lastName: string; // 1-100
    gender: 'male' | 'female';
    nationalId?: string; // max 30
    phone?: string; // max 20
    email?: string; // valid email, max 255
    specialization?: string; // max 100
    qualification?: string; // max 100
    photoUrl?: string; // valid URL
    hireDate: string; // date
    departmentId?: string | null; // UUID
  }
  ```
- **Response**: 201

#### Get Teacher

- **Method**: GET
- **URL**: `/api/v1/teachers/:id`
- **Auth**: Required | Permission: `teachers.read`

#### Update Teacher

- **Method**: PATCH
- **URL**: `/api/v1/teachers/:id`
- **Auth**: Required | Permission: `teachers.update`
- **Request**:
  ```typescript
  interface UpdateTeacherInput {
    firstName?: string;
    lastName?: string;
    gender?: 'male' | 'female';
    nationalId?: string | null;
    phone?: string | null;
    email?: string | null;
    specialization?: string | null;
    qualification?: string | null;
    photoUrl?: string | null;
    departmentId?: string | null;
    status?: 'active' | 'on_leave' | 'resigned' | 'terminated';
  }
  ```
- **Business Rules**: Status transitions validated

#### Delete Teacher

- **Method**: DELETE
- **URL**: `/api/v1/teachers/:id`
- **Auth**: Required | Permission: `teachers.delete`
- **Response**: 204 (soft delete)

#### Assign Subjects to Teacher

- **Method**: PUT
- **URL**: `/api/v1/teachers/:id/subjects`
- **Auth**: Required | Permission: `teachers.update`
- **Request**: `{ subjectIds: string[] }` (UUID array, min 0)

#### Get Teacher Subjects

- **Method**: GET
- **URL**: `/api/v1/teachers/:id/subjects`
- **Auth**: Required | Permission: `teachers.read`

---

### Guardians

#### List Guardians

- **Method**: GET
- **URL**: `/api/v1/guardians`
- **Auth**: Required | Permission: `guardians.list`
- **Query Params**:
  ```typescript
  interface ListGuardiansQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'firstName' | 'lastName'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
    search?: string; // max 255
  }
  ```

#### Create Guardian

- **Method**: POST
- **URL**: `/api/v1/guardians`
- **Auth**: Required | Permission: `guardians.create`
- **Request**:
  ```typescript
  interface CreateGuardianInput {
    firstName: string; // 1-100
    lastName: string; // 1-100
    phone: string; // 1-20
    email?: string; // valid email, max 255
    nationalId?: string; // max 30
    occupation?: string; // max 100
    address?: string;
  }
  ```
- **Response**: 201

#### Get Guardian

- **Method**: GET
- **URL**: `/api/v1/guardians/:id`
- **Auth**: Required | Permission: `guardians.read`

#### Update Guardian

- **Method**: PATCH
- **URL**: `/api/v1/guardians/:id`
- **Auth**: Required | Permission: `guardians.update`

#### Delete Guardian

- **Method**: DELETE
- **URL**: `/api/v1/guardians/:id`
- **Auth**: Required | Permission: `guardians.delete`
- **Response**: 204 (soft delete)

---

### Student-Guardian Relationships

#### List Student's Guardians

- **Method**: GET
- **URL**: `/api/v1/students/:studentId/guardians`
- **Auth**: Required | Permission: `student-guardians.list`

#### Link Guardian to Student

- **Method**: POST
- **URL**: `/api/v1/students/:studentId/guardians`
- **Auth**: Required | Permission: `student-guardians.create`
- **Request**:
  ```typescript
  interface CreateStudentGuardianInput {
    guardianId: string; // UUID
    relationshipType:
      | 'father'
      | 'mother'
      | 'brother'
      | 'sister'
      | 'uncle'
      | 'aunt'
      | 'grandparent'
      | 'other';
    isPrimary?: boolean; // default false
    isEmergencyContact?: boolean; // default false
  }
  ```
- **Response**: 201

#### Update Student-Guardian Link

- **Method**: PATCH
- **URL**: `/api/v1/students/:studentId/guardians/:id`
- **Auth**: Required | Permission: `student-guardians.update`
- **Request**:
  ```typescript
  interface UpdateStudentGuardianInput {
    relationshipType?:
      | 'father'
      | 'mother'
      | 'brother'
      | 'sister'
      | 'uncle'
      | 'aunt'
      | 'grandparent'
      | 'other';
    isPrimary?: boolean;
    isEmergencyContact?: boolean;
  }
  ```

#### Remove Guardian from Student

- **Method**: DELETE
- **URL**: `/api/v1/students/:studentId/guardians/:id`
- **Auth**: Required | Permission: `student-guardians.delete`
- **Response**: 204

---

### Enrollments

#### List Enrollments

- **Method**: GET
- **URL**: `/api/v1/enrollments`
- **Auth**: Required | Permission: `enrollments.list`
- **Query Params**:
  ```typescript
  interface ListEnrollmentsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'enrolledAt'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
    status?: 'active' | 'withdrawn' | 'transferred' | 'promoted';
    academicYearId?: string; // UUID
    classSectionId?: string; // UUID
    studentId?: string; // UUID
  }
  ```

#### Create Enrollment

- **Method**: POST
- **URL**: `/api/v1/enrollments`
- **Auth**: Required | Permission: `enrollments.create`
- **Request**:
  ```typescript
  interface CreateEnrollmentInput {
    studentId: string; // UUID
    classSectionId: string; // UUID
    academicYearId: string; // UUID
    enrolledAt: string; // date
    notes?: string;
  }
  ```
- **Response**: 201
- **Business Rules**: Prevents duplicate enrollment for same student/academic year

#### Get Enrollment

- **Method**: GET
- **URL**: `/api/v1/enrollments/:id`
- **Auth**: Required | Permission: `enrollments.read`

#### Update Enrollment

- **Method**: PATCH
- **URL**: `/api/v1/enrollments/:id`
- **Auth**: Required | Permission: `enrollments.update`
- **Request**:
  ```typescript
  interface UpdateEnrollmentInput {
    classSectionId?: string;
    status?: 'active' | 'withdrawn' | 'transferred' | 'promoted';
    withdrawnAt?: string | null; // date
    notes?: string | null;
  }
  ```

#### Delete Enrollment

- **Method**: DELETE
- **URL**: `/api/v1/enrollments/:id`
- **Auth**: Required | Permission: `enrollments.delete`
- **Response**: 204

#### Bulk Promote Students

- **Method**: POST
- **URL**: `/api/v1/enrollments/bulk-promote`
- **Auth**: Required | Permission: `enrollments.create`
- **Request**:
  ```typescript
  interface BulkPromoteInput {
    sourceClassSectionId: string; // UUID
    targetClassSectionId: string; // UUID
    targetAcademicYearId: string; // UUID
    studentIds: string[]; // UUID array, min 1
  }
  ```
- **Response**: 201

---

### Period Sets

#### List Period Sets

- **Method**: GET
- **URL**: `/api/v1/period-sets`
- **Auth**: Required | Permission: `period-sets.list`
- **Query Params**:
  ```typescript
  interface ListPeriodSetsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'name'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
    academicYearId?: string; // UUID
  }
  ```

#### Create Period Set

- **Method**: POST
- **URL**: `/api/v1/period-sets`
- **Auth**: Required | Permission: `period-sets.create`
- **Request**:
  ```typescript
  interface CreatePeriodSetInput {
    academicYearId: string; // UUID
    name?: string; // 1-50, default "Default"
  }
  ```
- **Response**: 201

#### Get Period Set

- **Method**: GET
- **URL**: `/api/v1/period-sets/:id`
- **Auth**: Required | Permission: `period-sets.read`

#### Update Period Set

- **Method**: PATCH
- **URL**: `/api/v1/period-sets/:id`
- **Auth**: Required | Permission: `period-sets.update`
- **Request**: `{ name: string }` (1-50)

#### Delete Period Set

- **Method**: DELETE
- **URL**: `/api/v1/period-sets/:id`
- **Auth**: Required | Permission: `period-sets.delete`
- **Response**: 204

---

### Working Days

#### List Working Days

- **Method**: GET
- **URL**: `/api/v1/period-sets/:setId/working-days`
- **Auth**: Required | Permission: `period-sets.read`

#### Replace Working Days

- **Method**: PUT
- **URL**: `/api/v1/period-sets/:setId/working-days`
- **Auth**: Required | Permission: `period-sets.update`
- **Request**:
  ```typescript
  interface ReplaceWorkingDaysInput {
    workingDays: Array<{
      dayOfWeek: number; // 0-6 (Sunday-Saturday)
      isActive: boolean;
    }>;
    // 1-7 items, unique dayOfWeek, at least one active day
  }
  ```

---

### Periods

#### List Periods

- **Method**: GET
- **URL**: `/api/v1/period-sets/:setId/periods`
- **Auth**: Required | Permission: `period-sets.read`

#### Replace Periods

- **Method**: PUT
- **URL**: `/api/v1/period-sets/:setId/periods`
- **Auth**: Required | Permission: `period-sets.update`
- **Request**:
  ```typescript
  interface ReplacePeriodsInput {
    periods: Array<{
      name: string; // 1-50
      startTime: string; // "HH:MM" format
      endTime: string; // "HH:MM", must be after startTime
      orderIndex: number; // positive int, unique
      isBreak?: boolean; // default false
    }>;
    // min 1, no overlapping times, unique orderIndex, at least one non-break
  }
  ```

---

### Time Slots

#### List Time Slots

- **Method**: GET
- **URL**: `/api/v1/period-sets/:setId/time-slots`
- **Auth**: Required | Permission: `period-sets.read`

#### Generate Time Slots

- **Method**: POST
- **URL**: `/api/v1/period-sets/:setId/time-slots/generate`
- **Auth**: Required | Permission: `period-sets.update`
- **Response** (201):
  ```typescript
  interface GenerateTimeSlotsResponse {
    totalSlotsGenerated: number;
    details: Array<{
      dayOfWeek: number;
      dayName: string;
      periodId: string;
      periodName: string;
      startTime: string;
      endTime: string;
      isBreak: boolean;
    }>;
  }
  ```

---

### Rooms

#### List Rooms

- **Method**: GET
- **URL**: `/api/v1/rooms`
- **Auth**: Required | Permission: `rooms.list`
- **Query Params**:
  ```typescript
  interface ListRoomsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'name' | 'capacity'; // default "name"
    order?: 'asc' | 'desc'; // default "asc"
    roomType?: 'classroom' | 'lab' | 'hall' | 'library' | 'gym' | 'office';
    building?: string; // max 50
  }
  ```

#### Create Room

- **Method**: POST
- **URL**: `/api/v1/rooms`
- **Auth**: Required | Permission: `rooms.create`
- **Request**:
  ```typescript
  interface CreateRoomInput {
    name: string; // 1-50, unique per school
    building?: string; // max 50
    floor?: string; // max 20
    capacity: number; // positive int
    roomType: 'classroom' | 'lab' | 'hall' | 'library' | 'gym' | 'office';
  }
  ```
- **Response**: 201

#### Get Room

- **Method**: GET
- **URL**: `/api/v1/rooms/:id`
- **Auth**: Required | Permission: `rooms.read`

#### Update Room

- **Method**: PATCH
- **URL**: `/api/v1/rooms/:id`
- **Auth**: Required | Permission: `rooms.update`

#### Delete Room

- **Method**: DELETE
- **URL**: `/api/v1/rooms/:id`
- **Auth**: Required | Permission: `rooms.delete`
- **Response**: 204

#### Assign Suitable Subjects to Room

- **Method**: PUT
- **URL**: `/api/v1/rooms/:roomId/subjects`
- **Auth**: Required | Permission: `rooms.update`
- **Request**: `{ subjectIds: string[] }` (UUID array, min 0)

#### Get Room's Suitable Subjects

- **Method**: GET
- **URL**: `/api/v1/rooms/:roomId/subjects`
- **Auth**: Required | Permission: `rooms.read`

---

### Lessons & Timetable

#### List Lessons

- **Method**: GET
- **URL**: `/api/v1/lessons`
- **Auth**: Required | Permission: `lessons.list`
- **Query Params**:
  ```typescript
  interface ListLessonsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    termId?: string; // UUID
    classSectionId?: string; // UUID
    teacherId?: string; // UUID
    dayOfWeek?: number; // 0-6
    sortBy?: 'createdAt'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
  }
  ```

#### Create Lesson

- **Method**: POST
- **URL**: `/api/v1/lessons`
- **Auth**: Required | Permission: `lessons.create`
- **Request**:
  ```typescript
  interface CreateLessonInput {
    academicYearId: string; // UUID
    termId: string; // UUID
    classSectionId: string; // UUID
    subjectId: string; // UUID
    teacherId: string; // UUID
    roomId: string; // UUID
    timeSlotId: string; // UUID
  }
  ```
- **Response**: 201
- **Business Rules**: Teacher must be qualified for subject; checks for teacher/class/room conflicts

#### Get Lesson

- **Method**: GET
- **URL**: `/api/v1/lessons/:id`
- **Auth**: Required | Permission: `lessons.read`

#### Update Lesson

- **Method**: PATCH
- **URL**: `/api/v1/lessons/:id`
- **Auth**: Required | Permission: `lessons.update`
- **Request**:
  ```typescript
  interface UpdateLessonInput {
    teacherId?: string; // UUID
    roomId?: string; // UUID
    timeSlotId?: string; // UUID
  }
  ```

#### Cancel Lesson

- **Method**: POST
- **URL**: `/api/v1/lessons/:id/cancel`
- **Auth**: Required | Permission: `lessons.delete`
- **Response**: 204

#### Bulk Create Lessons

- **Method**: POST
- **URL**: `/api/v1/lessons/bulk-create`
- **Auth**: Required | Permission: `lessons.create`
- **Request**: `{ lessons: CreateLessonInput[] }` (min 1)
- **Response** (201):
  ```typescript
  interface BulkCreateResponse {
    created: number;
    failed: number;
    errors: Array<{ index: number; code: string; message: string }>;
  }
  ```

#### Auto-Generate Timetable

- **Method**: POST
- **URL**: `/api/v1/lessons/auto-generate`
- **Auth**: Required | Permission: `lessons.create`
- **Request**:
  ```typescript
  interface AutoGenerateInput {
    termId: string; // UUID
    periodSetId: string; // UUID
    options: {
      respectTeacherAvailability?: boolean; // default true
      respectRoomSuitability?: boolean; // default true
      maxConsecutiveLessonsPerTeacher?: number; // positive int, default 4
    };
  }
  ```
- **Response**: Generation results with unfulfilled requirements

#### Clear Lessons

- **Method**: DELETE
- **URL**: `/api/v1/lessons/clear`
- **Auth**: Required | Permission: `lessons.delete`
- **Query Params**: `?termId=uuid` (required)

#### Timetable by Class

- **Method**: GET
- **URL**: `/api/v1/timetable/class/:classSectionId`
- **Auth**: Required | Permission: `lessons.list`
- **Query Params**: `?termId=uuid` (required)
- **Response**: 2D grid `{ [dayOfWeek]: { [periodId]: TimetableLesson } }`

#### Timetable by Teacher

- **Method**: GET
- **URL**: `/api/v1/timetable/teacher/:teacherId`
- **Auth**: Required | Permission: `lessons.list`
- **Query Params**: `?termId=uuid` (required)

#### Timetable by Room

- **Method**: GET
- **URL**: `/api/v1/timetable/room/:roomId`
- **Auth**: Required | Permission: `lessons.list`
- **Query Params**: `?termId=uuid` (required)

---

### Substitutions

#### List Substitutions

- **Method**: GET
- **URL**: `/api/v1/substitutions`
- **Auth**: Required | Permission: `substitutions.list`
- **Query Params**:
  ```typescript
  interface ListSubstitutionsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    date?: string; // date
    teacherId?: string; // UUID
    sortBy?: 'date' | 'createdAt'; // default "date"
    order?: 'asc' | 'desc'; // default "asc"
  }
  ```

#### Create Substitution

- **Method**: POST
- **URL**: `/api/v1/substitutions`
- **Auth**: Required | Permission: `substitutions.create`
- **Request**:
  ```typescript
  interface CreateSubstitutionInput {
    lessonId: string; // UUID
    substituteTeacherId: string; // UUID
    date: string; // date
    reason?: string;
  }
  ```
- **Response**: 201
- **Business Rules**: Substitute must be qualified; cannot be same as original teacher; no schedule conflicts

#### Get Substitution

- **Method**: GET
- **URL**: `/api/v1/substitutions/:id`
- **Auth**: Required | Permission: `substitutions.read`

#### Update Substitution

- **Method**: PATCH
- **URL**: `/api/v1/substitutions/:id`
- **Auth**: Required | Permission: `substitutions.update`

#### Delete Substitution

- **Method**: DELETE
- **URL**: `/api/v1/substitutions/:id`
- **Auth**: Required | Permission: `substitutions.delete`
- **Response**: 204

---

### Teacher Availability

#### Get Teacher Availability

- **Method**: GET
- **URL**: `/api/v1/teachers/:teacherId/availability`
- **Auth**: Required | Permission: `teacher-availability.list`

#### Replace Teacher Availability

- **Method**: PUT
- **URL**: `/api/v1/teachers/:teacherId/availability`
- **Auth**: Required | Permission: `teacher-availability.update`
- **Request**:
  ```typescript
  interface ReplaceAvailabilityInput {
    slots: Array<{
      dayOfWeek: number; // 0-6
      periodId: string; // UUID
      isAvailable: boolean;
    }>;
    // min 1
  }
  ```

---

### Teacher Leave

#### List Teacher Leaves

- **Method**: GET
- **URL**: `/api/v1/teacher-leaves`
- **Auth**: Required | Permission: `teacher-leaves.list`
- **Query Params**:
  ```typescript
  interface ListTeacherLeavesQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'dateFrom'; // default "dateFrom"
    order?: 'asc' | 'desc'; // default "desc"
    teacherId?: string; // UUID
    status?: 'pending' | 'approved' | 'rejected' | 'cancelled';
  }
  ```

#### Create Teacher Leave

- **Method**: POST
- **URL**: `/api/v1/teacher-leaves`
- **Auth**: Required | Permission: `teacher-leaves.create`
- **Request**:
  ```typescript
  interface CreateTeacherLeaveInput {
    teacherId: string; // UUID
    leaveType: 'sick' | 'personal' | 'maternity' | 'paternity' | 'annual' | 'unpaid' | 'other';
    dateFrom: string; // date
    dateTo: string; // date, must be >= dateFrom
    reason?: string; // max 500
  }
  ```
- **Response**: 201
- **Business Rules**: Checks for overlapping approved leaves

#### Get Teacher Leave

- **Method**: GET
- **URL**: `/api/v1/teacher-leaves/:id`
- **Auth**: Required | Permission: `teacher-leaves.read`

#### Approve Leave

- **Method**: POST
- **URL**: `/api/v1/teacher-leaves/:id/approve`
- **Auth**: Required | Permission: `teacher-leaves.update`
- **Business Rules**: Must be in `pending` status

#### Reject Leave

- **Method**: POST
- **URL**: `/api/v1/teacher-leaves/:id/reject`
- **Auth**: Required | Permission: `teacher-leaves.update`
- **Business Rules**: Must be in `pending` status

#### Cancel Leave

- **Method**: POST
- **URL**: `/api/v1/teacher-leaves/:id/cancel`
- **Auth**: Required | Permission: `teacher-leaves.update`
- **Business Rules**: Cannot cancel if leave already started

---

### Student Attendance

#### List Student Attendance

- **Method**: GET
- **URL**: `/api/v1/student-attendance`
- **Auth**: Required | Permission: `student-attendance.list`
- **Query Params**:
  ```typescript
  interface ListStudentAttendanceQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'date' | 'createdAt'; // default "date"
    order?: 'asc' | 'desc'; // default "desc"
    classSectionId?: string; // UUID
    studentId?: string; // UUID
    date?: string; // date
    status?: 'present' | 'absent' | 'late' | 'excused';
  }
  ```

#### Get Attendance Record

- **Method**: GET
- **URL**: `/api/v1/student-attendance/:id`
- **Auth**: Required | Permission: `student-attendance.read`

#### Bulk Record Attendance

- **Method**: POST
- **URL**: `/api/v1/student-attendance/bulk`
- **Auth**: Required | Permission: `student-attendance.create`
- **Request**:
  ```typescript
  interface BulkStudentAttendanceInput {
    classSectionId: string; // UUID
    date: string; // date
    lessonId?: string; // UUID (for per-lesson attendance)
    records: Array<{
      studentId: string; // UUID
      status: 'present' | 'absent' | 'late' | 'excused';
      notes?: string; // max 500
    }>;
    // min 1 record
  }
  ```
- **Response**: 201 (upsert - creates or updates existing records)

#### Correct Attendance

- **Method**: PATCH
- **URL**: `/api/v1/student-attendance/:id`
- **Auth**: Required | Permission: `student-attendance.update`
- **Request**:
  ```typescript
  interface CorrectStudentAttendanceInput {
    status: 'present' | 'absent' | 'late' | 'excused';
    notes?: string; // max 500
  }
  ```

#### Attendance Summary

- **Method**: GET
- **URL**: `/api/v1/student-attendance/summary`
- **Auth**: Required | Permission: `student-attendance.list`
- **Query Params**:
  ```typescript
  interface AttendanceSummaryQuery {
    classSectionId: string; // UUID, required
    dateFrom: string; // date, required
    dateTo: string; // date, required
    studentId?: string; // UUID
  }
  ```
- **Response**:
  ```typescript
  interface AttendanceSummary {
    students: Array<{
      studentId: string;
      present: number;
      absent: number;
      late: number;
      excused: number;
      total: number;
      attendanceRate: number; // ((present + late) / total) * 100
    }>;
  }
  ```

---

### Teacher Attendance

#### List Teacher Attendance

- **Method**: GET
- **URL**: `/api/v1/teacher-attendance`
- **Auth**: Required | Permission: `teacher-attendance.list`
- **Query Params**:
  ```typescript
  interface ListTeacherAttendanceQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'date' | 'createdAt'; // default "date"
    order?: 'asc' | 'desc'; // default "desc"
    teacherId?: string; // UUID
    date?: string; // date
    status?: 'present' | 'absent' | 'late' | 'on_leave';
  }
  ```

#### Get Teacher Attendance Record

- **Method**: GET
- **URL**: `/api/v1/teacher-attendance/:id`
- **Auth**: Required | Permission: `teacher-attendance.read`

#### Record Teacher Attendance

- **Method**: POST
- **URL**: `/api/v1/teacher-attendance`
- **Auth**: Required | Permission: `teacher-attendance.create`
- **Request**:
  ```typescript
  interface RecordTeacherAttendanceInput {
    teacherId: string; // UUID
    date: string; // date
    status: 'present' | 'absent' | 'late' | 'on_leave';
    checkIn?: string; // "HH:MM"
    checkOut?: string; // "HH:MM"
  }
  ```
- **Response**: 201
- **Business Rules**: Prevents duplicate records for same teacher/date

#### Correct Teacher Attendance

- **Method**: PATCH
- **URL**: `/api/v1/teacher-attendance/:id`
- **Auth**: Required | Permission: `teacher-attendance.update`
- **Request**:
  ```typescript
  interface CorrectTeacherAttendanceInput {
    status?: 'present' | 'absent' | 'late' | 'on_leave';
    checkIn?: string; // "HH:MM"
    checkOut?: string; // "HH:MM"
  }
  ```

---

### Grading Scales

#### List Grading Scales

- **Method**: GET
- **URL**: `/api/v1/grading-scales`
- **Auth**: Required | Permission: `grading-scales.list`
- **Query Params**:
  ```typescript
  interface ListGradingScalesQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'name'; // default "name"
    order?: 'asc' | 'desc'; // default "asc"
  }
  ```

#### Create Grading Scale

- **Method**: POST
- **URL**: `/api/v1/grading-scales`
- **Auth**: Required | Permission: `grading-scales.create`
- **Request**:
  ```typescript
  interface CreateGradingScaleInput {
    name: string; // 1-50, unique per school
    levels: Array<{
      letter: string; // max 5 (e.g. "A+", "B", "F")
      minScore: number; // 0-100
      maxScore: number; // 0-100
      gpaPoints?: number; // 0-9.99
      orderIndex: number; // positive int
    }>;
    // min 1 level
  }
  ```
- **Response**: 201

#### Get Grading Scale

- **Method**: GET
- **URL**: `/api/v1/grading-scales/:id`
- **Auth**: Required | Permission: `grading-scales.read`

#### Update Grading Scale

- **Method**: PATCH
- **URL**: `/api/v1/grading-scales/:id`
- **Auth**: Required | Permission: `grading-scales.update`

#### Delete Grading Scale

- **Method**: DELETE
- **URL**: `/api/v1/grading-scales/:id`
- **Auth**: Required | Permission: `grading-scales.delete`
- **Response**: 204
- **Business Rules**: Cannot delete if used by exams

---

### Exams

#### List Exams

- **Method**: GET
- **URL**: `/api/v1/exams`
- **Auth**: Required | Permission: `exams.list`
- **Query Params**:
  ```typescript
  interface ListExamsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'name' | 'startDate'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
    termId?: string; // UUID
    examType?: 'quiz' | 'midterm' | 'final' | 'assignment' | 'practical';
  }
  ```

#### Create Exam

- **Method**: POST
- **URL**: `/api/v1/exams`
- **Auth**: Required | Permission: `exams.create`
- **Request**:
  ```typescript
  interface CreateExamInput {
    academicYearId: string; // UUID
    termId: string; // UUID
    gradingScaleId: string; // UUID
    name: string; // 1-100
    examType: 'quiz' | 'midterm' | 'final' | 'assignment' | 'practical';
    weight?: number; // 0-100, default 100
    startDate?: string; // date
    endDate?: string; // date
  }
  ```
- **Response**: 201

#### Get Exam

- **Method**: GET
- **URL**: `/api/v1/exams/:id`
- **Auth**: Required | Permission: `exams.read`

#### Update Exam

- **Method**: PATCH
- **URL**: `/api/v1/exams/:id`
- **Auth**: Required | Permission: `exams.update`

#### Delete Exam

- **Method**: DELETE
- **URL**: `/api/v1/exams/:id`
- **Auth**: Required | Permission: `exams.delete`
- **Response**: 204
- **Business Rules**: Cannot delete if has grades

---

### Exam Subjects

#### List Exam Subjects

- **Method**: GET
- **URL**: `/api/v1/exams/:examId/subjects`
- **Auth**: Required | Permission: `exam-subjects.list`

#### Add Subject to Exam

- **Method**: POST
- **URL**: `/api/v1/exams/:examId/subjects`
- **Auth**: Required | Permission: `exam-subjects.create`
- **Request**:
  ```typescript
  interface CreateExamSubjectInput {
    subjectId: string; // UUID
    gradeId: string; // UUID
    maxScore: number; // > 0, max 999
    passScore?: number; // >= 0
    examDate?: string; // date
    examTime?: string; // "HH:MM"
  }
  ```
- **Response**: 201

#### Update Exam Subject

- **Method**: PATCH
- **URL**: `/api/v1/exams/:examId/subjects/:id`
- **Auth**: Required | Permission: `exam-subjects.update`

#### Remove Subject from Exam

- **Method**: DELETE
- **URL**: `/api/v1/exams/:examId/subjects/:id`
- **Auth**: Required | Permission: `exam-subjects.delete`
- **Response**: 204
- **Business Rules**: Cannot remove if has grades

---

### Student Grades

#### List Student Grades

- **Method**: GET
- **URL**: `/api/v1/student-grades`
- **Auth**: Required | Permission: `student-grades.list`
- **Query Params**:
  ```typescript
  interface ListGradesQuery {
    page?: number; // default 1
    limit?: number; // 1-100, default 50
    sortBy?: 'createdAt' | 'score'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
    examSubjectId?: string; // UUID
    studentId?: string; // UUID
  }
  ```

#### Bulk Record Grades

- **Method**: POST
- **URL**: `/api/v1/student-grades/bulk`
- **Auth**: Required | Permission: `student-grades.create`
- **Request**:
  ```typescript
  interface BulkGradeInput {
    examSubjectId: string; // UUID
    grades: Array<{
      studentId: string; // UUID
      score: number; // >= 0, must be <= maxScore
      notes?: string; // max 500
    }>;
    // min 1
  }
  ```
- **Response**: 201
- **Business Rules**: Auto-computes grade letter from grading scale

#### Correct Grade

- **Method**: PATCH
- **URL**: `/api/v1/student-grades/:id`
- **Auth**: Required | Permission: `student-grades.update`
- **Request**:
  ```typescript
  interface CorrectGradeInput {
    score?: number; // >= 0
    notes?: string; // max 500
  }
  ```

#### Grade Report

- **Method**: GET
- **URL**: `/api/v1/student-grades/report`
- **Auth**: Required | Permission: `student-grades.list`
- **Query Params**:
  ```typescript
  interface GradeReportQuery {
    termId: string; // UUID, required
    classSectionId: string; // UUID, required
  }
  ```
- **Response**: Per-student weighted averages by subject with overall percentage and GPA

---

### Report Cards

#### List Report Cards

- **Method**: GET
- **URL**: `/api/v1/report-cards`
- **Auth**: Required | Permission: `report-cards.list`
- **Query Params**:
  ```typescript
  interface ListReportCardsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'generatedAt' | 'overallPercentage' | 'rankInClass'; // default "generatedAt"
    order?: 'asc' | 'desc'; // default "desc"
    termId?: string; // UUID
    classSectionId?: string; // UUID
    studentId?: string; // UUID
  }
  ```

#### Get Report Card

- **Method**: GET
- **URL**: `/api/v1/report-cards/:id`
- **Auth**: Required | Permission: `report-cards.read`

#### Generate Report Cards

- **Method**: POST
- **URL**: `/api/v1/report-cards`
- **Auth**: Required | Permission: `report-cards.create`
- **Request**:
  ```typescript
  interface GenerateReportCardsInput {
    termId: string; // UUID
    classSectionId: string; // UUID
  }
  ```
- **Response** (201):
  ```typescript
  interface GenerateResponse {
    generated: number;
    missingGrades: number;
    skippedExisting: number;
  }
  ```
- **Business Rules**: Computes weighted averages, GPA, percentage, rank in class

#### Update Report Card Remarks

- **Method**: PATCH
- **URL**: `/api/v1/report-cards/:id/remarks`
- **Auth**: Required | Permission: `report-cards.update`
- **Request**:
  ```typescript
  interface UpdateRemarksInput {
    teacherRemarks?: string; // max 1000
    rankInClass?: number; // positive int
  }
  ```

---

### Fee Categories

#### List Fee Categories

- **Method**: GET
- **URL**: `/api/v1/fee-categories`
- **Auth**: Required | Permission: `fee-categories.list`
- **Query Params**:
  ```typescript
  interface ListFeeCategoriesQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'name'; // default "name"
    order?: 'asc' | 'desc'; // default "asc"
  }
  ```

#### Create Fee Category

- **Method**: POST
- **URL**: `/api/v1/fee-categories`
- **Auth**: Required | Permission: `fee-categories.create`
- **Request**: `{ name: string }` (1-100, unique per school)
- **Response**: 201

#### Update Fee Category

- **Method**: PATCH
- **URL**: `/api/v1/fee-categories/:id`
- **Auth**: Required | Permission: `fee-categories.update`

#### Delete Fee Category

- **Method**: DELETE
- **URL**: `/api/v1/fee-categories/:id`
- **Auth**: Required | Permission: `fee-categories.delete`
- **Response**: 204
- **Business Rules**: Cannot delete if has fee structures

---

### Fee Structures

#### List Fee Structures

- **Method**: GET
- **URL**: `/api/v1/fee-structures`
- **Auth**: Required | Permission: `fee-structures.list`
- **Query Params**:
  ```typescript
  interface ListFeeStructuresQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'name' | 'amount'; // default "name"
    order?: 'asc' | 'desc'; // default "asc"
    academicYearId?: string; // UUID
    gradeId?: string; // UUID
    feeCategoryId?: string; // UUID
    isRecurring?: boolean;
  }
  ```

#### Create Fee Structure

- **Method**: POST
- **URL**: `/api/v1/fee-structures`
- **Auth**: Required | Permission: `fee-structures.create`
- **Request**:
  ```typescript
  interface CreateFeeStructureInput {
    academicYearId: string; // UUID
    gradeId: string; // UUID
    feeCategoryId: string; // UUID
    name: string; // 1-100
    amount: number; // > 0
    dueDate?: string; // date
    isRecurring?: boolean; // default false
    recurrence?: 'monthly' | 'quarterly' | 'term' | 'annual';
    // if isRecurring=true, recurrence required; if false, recurrence must be null
  }
  ```
- **Response**: 201

#### Update Fee Structure

- **Method**: PATCH
- **URL**: `/api/v1/fee-structures/:id`
- **Auth**: Required | Permission: `fee-structures.update`

#### Delete Fee Structure

- **Method**: DELETE
- **URL**: `/api/v1/fee-structures/:id`
- **Auth**: Required | Permission: `fee-structures.delete`
- **Response**: 204

---

### Fee Discounts

#### List Fee Discounts

- **Method**: GET
- **URL**: `/api/v1/fee-discounts`
- **Auth**: Required | Permission: `fee-discounts.list`
- **Query Params**:
  ```typescript
  interface ListFeeDiscountsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
    studentId?: string; // UUID
    feeStructureId?: string; // UUID
  }
  ```

#### Create Fee Discount

- **Method**: POST
- **URL**: `/api/v1/fee-discounts`
- **Auth**: Required | Permission: `fee-discounts.create`
- **Request**:
  ```typescript
  interface CreateFeeDiscountInput {
    studentId: string; // UUID
    feeStructureId: string; // UUID
    discountType: 'percentage' | 'fixed';
    amount: number; // > 0, if percentage then max 100
    reason?: string; // max 500
  }
  ```
- **Response**: 201
- **Business Rules**: One discount per student per fee structure

#### Update Fee Discount

- **Method**: PATCH
- **URL**: `/api/v1/fee-discounts/:id`
- **Auth**: Required | Permission: `fee-discounts.update`

#### Delete Fee Discount

- **Method**: DELETE
- **URL**: `/api/v1/fee-discounts/:id`
- **Auth**: Required | Permission: `fee-discounts.delete`
- **Response**: 204

---

### Fee Invoices

#### List Fee Invoices

- **Method**: GET
- **URL**: `/api/v1/fee-invoices`
- **Auth**: Required | Permission: `fee-invoices.list`
- **Query Params**:
  ```typescript
  interface ListFeeInvoicesQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'dueDate' | 'netAmount'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
    studentId?: string; // UUID
    status?: 'draft' | 'issued' | 'partially_paid' | 'paid' | 'overdue' | 'cancelled';
  }
  ```

#### Create Fee Invoice

- **Method**: POST
- **URL**: `/api/v1/fee-invoices`
- **Auth**: Required | Permission: `fee-invoices.create`
- **Request**:
  ```typescript
  interface CreateFeeInvoiceInput {
    studentId: string; // UUID
    dueDate: string; // date
    items: Array<{
      feeStructureId: string; // UUID
      description?: string; // max 255
      quantity?: number; // positive int, default 1
      unitAmount: number; // > 0
    }>;
    // min 1 item
  }
  ```
- **Response**: 201
- **Computed Fields**:
  - `totalAmount = sum(quantity * unitAmount)` per item
  - Discounts auto-applied from FeeDiscount records
  - `netAmount = totalAmount - discountAmount` (must be >= 0)

#### Get Fee Invoice

- **Method**: GET
- **URL**: `/api/v1/fee-invoices/:id`
- **Auth**: Required | Permission: `fee-invoices.read`

#### Bulk Generate Invoices

- **Method**: POST
- **URL**: `/api/v1/fee-invoices/bulk-generate`
- **Auth**: Required | Permission: `fee-invoices.create`
- **Request**:
  ```typescript
  interface BulkGenerateInput {
    academicYearId: string; // UUID
    gradeId: string; // UUID
    dueDate: string; // date
    feeStructureIds: string[]; // UUID array, min 1
  }
  ```
- **Response** (201):
  ```typescript
  interface BulkGenerateResponse {
    totalCreated: number;
    totalNet: number;
    skipped: Array<{ studentId: string; reason: string }>;
  }
  ```

#### Issue Invoice

- **Method**: POST
- **URL**: `/api/v1/fee-invoices/:id/issue`
- **Auth**: Required | Permission: `fee-invoices.update`
- **Request**: `{ notifyGuardian?: boolean }` (default false)
- **Business Rules**: Invoice must be in `draft` status

#### Cancel Invoice

- **Method**: POST
- **URL**: `/api/v1/fee-invoices/:id/cancel`
- **Auth**: Required | Permission: `fee-invoices.update`
- **Request**: `{ reason?: string }` (max 500)
- **Business Rules**: Cannot cancel if has payments

---

### Fee Payments

#### List Fee Payments

- **Method**: GET
- **URL**: `/api/v1/fee-payments`
- **Auth**: Required | Permission: `fee-payments.list`
- **Query Params**:
  ```typescript
  interface ListFeePaymentsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'paymentDate' | 'amountPaid'; // default "paymentDate"
    order?: 'asc' | 'desc'; // default "desc"
    invoiceId?: string; // UUID
    paymentMethod?: 'cash' | 'bank_transfer' | 'card' | 'cheque' | 'online';
  }
  ```

#### Record Fee Payment

- **Method**: POST
- **URL**: `/api/v1/fee-payments`
- **Auth**: Required | Permission: `fee-payments.create`
- **Request**:
  ```typescript
  interface CreateFeePaymentInput {
    invoiceId: string; // UUID
    amountPaid: number; // > 0
    paymentDate: string; // date
    paymentMethod: 'cash' | 'bank_transfer' | 'card' | 'cheque' | 'online';
    referenceNumber?: string; // max 50
    notes?: string; // max 500
  }
  ```
- **Response**: 201
- **Business Rules**:
  - Invoice must be payable (issued/partially_paid/overdue)
  - Cannot overpay (tolerance: 0.1%)
  - Auto-updates invoice status to `paid` or `partially_paid`
- **Note**: Payments are immutable (no update/delete)

#### Get Fee Payment

- **Method**: GET
- **URL**: `/api/v1/fee-payments/:id`
- **Auth**: Required | Permission: `fee-payments.read`

---

### Financial Reports

#### Outstanding Fees Report

- **Method**: GET
- **URL**: `/api/v1/reports/fees/outstanding`
- **Auth**: Required | Permission: `financial-reports.read`
- **Query Params**:
  ```typescript
  interface OutstandingQuery {
    academicYearId?: string; // UUID
    gradeId?: string; // UUID
    status?: 'issued' | 'partially_paid' | 'overdue';
  }
  ```
- **Response**: Per-invoice balance, top 20 debtors, summary by status

#### Collection Report

- **Method**: GET
- **URL**: `/api/v1/reports/fees/collection`
- **Auth**: Required | Permission: `financial-reports.read`
- **Query Params**:
  ```typescript
  interface CollectionQuery {
    from: string; // date, required
    to: string; // date, required
    paymentMethod?: 'cash' | 'bank_transfer' | 'card' | 'cheque' | 'online';
  }
  ```
- **Response**: Total collected, grouped by payment method (count + total), timeline by date

#### Student Balance Report

- **Method**: GET
- **URL**: `/api/v1/reports/fees/student-balance`
- **Auth**: Required | Permission: `financial-reports.read`
- **Query Params**:
  ```typescript
  interface StudentBalanceQuery {
    page?: number; // default 1
    limit?: number; // default 20
    gradeId?: string; // UUID
    search?: string; // max 255
  }
  ```
- **Response**: Per-student `{ totalInvoiced, totalPaid, balance, invoiceCount }`

#### Category Breakdown Report

- **Method**: GET
- **URL**: `/api/v1/reports/fees/category-breakdown`
- **Auth**: Required | Permission: `financial-reports.read`
- **Query Params**:
  ```typescript
  interface CategoryBreakdownQuery {
    academicYearId?: string; // UUID
    from?: string; // date
    to?: string; // date
  }
  ```
- **Response**: Per-category `{ totalAmount, itemCount, percentage }`

---

### Announcements

#### List Announcements

- **Method**: GET
- **URL**: `/api/v1/announcements`
- **Auth**: Required | Permission: `announcements.list`
- **Query Params**:
  ```typescript
  interface ListAnnouncementsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt' | 'publishedAt' | 'title'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
    isDraft?: boolean;
    targetType?: 'all' | 'role' | 'grade' | 'class_section';
  }
  ```

#### Create Announcement

- **Method**: POST
- **URL**: `/api/v1/announcements`
- **Auth**: Required | Permission: `announcements.create`
- **Request**:
  ```typescript
  interface CreateAnnouncementInput {
    title: string; // 1-255
    body: string; // min 1
    expiresAt?: string; // date
    targets: Array<{
      targetType: 'all' | 'role' | 'grade' | 'class_section';
      targetRoleId?: string; // UUID, required if targetType = "role"
      targetGradeId?: string; // UUID, required if targetType = "grade"
      targetClassSectionId?: string; // UUID, required if targetType = "class_section"
    }>;
    // min 1 target
  }
  ```
- **Response**: 201 (created as draft)

#### Get Announcement

- **Method**: GET
- **URL**: `/api/v1/announcements/:id`
- **Auth**: Required | Permission: `announcements.read`

#### Update Announcement

- **Method**: PATCH
- **URL**: `/api/v1/announcements/:id`
- **Auth**: Required | Permission: `announcements.update`
- **Business Rules**: Cannot update if already published

#### Delete Announcement

- **Method**: DELETE
- **URL**: `/api/v1/announcements/:id`
- **Auth**: Required | Permission: `announcements.delete`
- **Response**: 204

#### Publish Announcement

- **Method**: POST
- **URL**: `/api/v1/announcements/:id/publish`
- **Auth**: Required | Permission: `announcements.update`
- **Business Rules**: Must be in draft status; cannot publish twice

---

### Notifications

#### List My Notifications

- **Method**: GET
- **URL**: `/api/v1/notifications`
- **Auth**: Required
- **Query Params**:
  ```typescript
  interface ListNotificationsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    isRead?: boolean;
    channel?: 'in_app' | 'sms' | 'email' | 'push';
  }
  ```

#### Get Unread Count

- **Method**: GET
- **URL**: `/api/v1/notifications/unread-count`
- **Auth**: Required
- **Response**: `{ count: number }`

#### Mark Notification as Read

- **Method**: POST
- **URL**: `/api/v1/notifications/:id/read`
- **Auth**: Required

#### Mark All as Read

- **Method**: POST
- **URL**: `/api/v1/notifications/read-all`
- **Auth**: Required

#### Send Notification

- **Method**: POST
- **URL**: `/api/v1/notifications/send`
- **Auth**: Required | Permission: `notifications.create`
- **Request**:
  ```typescript
  interface SendNotificationInput {
    userIds: string[]; // UUID array, min 1
    title: string; // 1-255
    body: string; // min 1
    channels: Array<'in_app' | 'sms' | 'email' | 'push'>; // min 1
  }
  ```
- **Response**: 201
- **Note**: Creates cartesian product: each user x each channel

---

### Academic Events

#### List Academic Events

- **Method**: GET
- **URL**: `/api/v1/academic-events`
- **Auth**: Required | Permission: `academic-events.list`
- **Query Params**:
  ```typescript
  interface ListAcademicEventsQuery {
    page?: number; // default 1
    limit?: number; // 1-100, default 20
    sortBy?: 'createdAt' | 'startDate' | 'title'; // default "startDate"
    order?: 'asc' | 'desc'; // default "asc"
    academicYearId?: string; // UUID
    eventType?: 'holiday' | 'exam_period' | 'meeting' | 'activity' | 'ceremony' | 'other';
    from?: string; // date
    to?: string; // date
  }
  ```

#### Create Academic Event

- **Method**: POST
- **URL**: `/api/v1/academic-events`
- **Auth**: Required | Permission: `academic-events.create`
- **Request**:
  ```typescript
  interface CreateAcademicEventInput {
    academicYearId: string; // UUID
    title: string; // 1-255
    description?: string; // max 2000
    eventType: 'holiday' | 'exam_period' | 'meeting' | 'activity' | 'ceremony' | 'other';
    startDate: string; // date
    endDate: string; // date, must be >= startDate
    isSchoolClosed?: boolean; // default false
  }
  ```
- **Response**: 201

#### Get Academic Event

- **Method**: GET
- **URL**: `/api/v1/academic-events/:id`
- **Auth**: Required | Permission: `academic-events.read`

#### Update Academic Event

- **Method**: PATCH
- **URL**: `/api/v1/academic-events/:id`
- **Auth**: Required | Permission: `academic-events.update`

#### Delete Academic Event

- **Method**: DELETE
- **URL**: `/api/v1/academic-events/:id`
- **Auth**: Required | Permission: `academic-events.delete`
- **Response**: 204

---

### Audit Logs

#### List Audit Logs

- **Method**: GET
- **URL**: `/api/v1/audit-logs`
- **Auth**: Required | Permission: `audit-logs.list`
- **Feature Gate**: `audit_logs` (premium+)
- **Query Params**:
  ```typescript
  interface ListAuditLogsQuery {
    page?: number; // default 1
    limit?: number; // default 20
    sortBy?: 'createdAt'; // default "createdAt"
    order?: 'asc' | 'desc'; // default "desc"
    tableName?: string; // max 100
    recordId?: string; // UUID
    userId?: string; // UUID
    action?: 'INSERT' | 'UPDATE' | 'DELETE';
    dateFrom?: string; // date
    dateTo?: string; // date
  }
  ```

#### Get Audit Log

- **Method**: GET
- **URL**: `/api/v1/audit-logs/:id`
- **Auth**: Required | Permission: `audit-logs.read`
- **Feature Gate**: `audit_logs` (premium+)

---

### Dashboard

#### Overview

- **Method**: GET
- **URL**: `/api/v1/dashboard/overview`
- **Auth**: Required | Permission: `dashboard.read`

#### Attendance Today

- **Method**: GET
- **URL**: `/api/v1/dashboard/attendance-today`
- **Auth**: Required | Permission: `dashboard.read`
- **Query Params**: `{ date?: string }` (date, defaults to today)

#### Fees Summary

- **Method**: GET
- **URL**: `/api/v1/dashboard/fees-summary`
- **Auth**: Required | Permission: `dashboard.read`

#### Recent Activity

- **Method**: GET
- **URL**: `/api/v1/dashboard/recent-activity`
- **Auth**: Required | Permission: `dashboard.read`
- **Note**: Hardcoded limit of 20 items

#### Platform Dashboard (Super Admin)

- **Method**: GET
- **URL**: `/api/v1/platform/dashboard`
- **Auth**: Required | Platform admin

#### Expiring Schools (Super Admin)

- **Method**: GET
- **URL**: `/api/v1/platform/schools/expiring`
- **Auth**: Required | Platform admin

---

### Self-Service (My)

All self-service endpoints automatically scope to the authenticated user's linked teacher/student/guardian.

#### My Timetable

- **Method**: GET
- **URL**: `/api/v1/my/timetable`
- **Auth**: Required (teacher or student)
- **Query Params**: `{ termId?: string }` (UUID)
- **Errors**: 403 if user is not linked to a teacher or student

#### My Classes (Teacher)

- **Method**: GET
- **URL**: `/api/v1/my/classes`
- **Auth**: Required (teacher)
- **Query Params**: `{ page?: number, limit?: number }`
- **Errors**: 403 `NOT_A_TEACHER` if user is not linked to a teacher

#### My Leaves (Teacher)

- **Method**: GET
- **URL**: `/api/v1/my/leaves`
- **Auth**: Required (teacher)
- **Query Params**: `{ page?: number, limit?: number }`

#### Submit Leave (Teacher)

- **Method**: POST
- **URL**: `/api/v1/my/leaves`
- **Auth**: Required (teacher)
- **Request**:
  ```typescript
  interface SubmitLeaveInput {
    leaveType: 'sick' | 'personal' | 'maternity' | 'paternity' | 'annual' | 'unpaid' | 'other';
    dateFrom: string; // date
    dateTo: string; // date, must be >= dateFrom
    reason?: string; // max 500
  }
  ```
- **Response**: 201

#### My Substitutions (Teacher)

- **Method**: GET
- **URL**: `/api/v1/my/substitutions`
- **Auth**: Required (teacher)
- **Query Params**: `{ page?: number, limit?: number }`

#### My Grades (Student)

- **Method**: GET
- **URL**: `/api/v1/my/grades`
- **Auth**: Required (student)
- **Query Params**:
  ```typescript
  interface GradesQuery {
    page?: number; // default 1
    limit?: number; // default 20
    termId?: string; // UUID
    examId?: string; // UUID
  }
  ```
- **Errors**: 403 `NOT_A_STUDENT` if user is not linked to a student

#### My Attendance (Student)

- **Method**: GET
- **URL**: `/api/v1/my/attendance`
- **Auth**: Required (student)
- **Query Params**:
  ```typescript
  interface AttendanceQuery {
    page?: number; // default 1
    limit?: number; // default 20
    from?: string; // date
    to?: string; // date
  }
  ```

#### My Report Cards (Student)

- **Method**: GET
- **URL**: `/api/v1/my/report-cards`
- **Auth**: Required (student)
- **Query Params**: `{ page?: number, limit?: number }`

#### My Invoices (Student)

- **Method**: GET
- **URL**: `/api/v1/my/invoices`
- **Auth**: Required (student)
- **Query Params**: `{ page?: number, limit?: number }`

#### My Children (Guardian)

- **Method**: GET
- **URL**: `/api/v1/my/children`
- **Auth**: Required (guardian)
- **Errors**: 403 `NOT_A_GUARDIAN` if user is not linked to a guardian

#### Child Grades (Guardian)

- **Method**: GET
- **URL**: `/api/v1/my/children/:studentId/grades`
- **Auth**: Required (guardian)
- **Query Params**: Same as My Grades
- **Errors**: 403 `NOT_GUARDIAN_OF_STUDENT` if guardian is not linked to this student

#### Child Attendance (Guardian)

- **Method**: GET
- **URL**: `/api/v1/my/children/:studentId/attendance`
- **Auth**: Required (guardian)
- **Query Params**: Same as My Attendance

#### Child Report Cards (Guardian)

- **Method**: GET
- **URL**: `/api/v1/my/children/:studentId/report-cards`
- **Auth**: Required (guardian)

#### Child Invoices (Guardian)

- **Method**: GET
- **URL**: `/api/v1/my/children/:studentId/invoices`
- **Auth**: Required (guardian)

---

## Enums

### SchoolStatus

| Value     | Description           |
| --------- | --------------------- |
| active    | School is operational |
| suspended | Temporarily suspended |
| archived  | Permanently archived  |

### SubscriptionPlan

| Value      | Description                                      |
| ---------- | ------------------------------------------------ |
| free       | Free tier                                        |
| basic      | Basic features (report cards, fee management)    |
| premium    | Advanced features (scheduling, audit logs, etc.) |
| enterprise | Full access including API                        |

### Gender

| Value  | Description |
| ------ | ----------- |
| male   | Male        |
| female | Female      |

### StudentStatus

| Value       | Description             |
| ----------- | ----------------------- |
| active      | Currently enrolled      |
| graduated   | Completed studies       |
| withdrawn   | Voluntarily left        |
| suspended   | Temporarily suspended   |
| transferred | Moved to another school |

### TeacherStatus

| Value      | Description           |
| ---------- | --------------------- |
| active     | Currently employed    |
| on_leave   | On approved leave     |
| resigned   | Voluntarily resigned  |
| terminated | Employment terminated |

### BloodType

| Value  | Display |
| ------ | ------- |
| A_POS  | A+      |
| A_NEG  | A-      |
| B_POS  | B+      |
| B_NEG  | B-      |
| AB_POS | AB+     |
| AB_NEG | AB-     |
| O_POS  | O+      |
| O_NEG  | O-      |

### RelationshipType

| Value       | Description |
| ----------- | ----------- |
| father      | Father      |
| mother      | Mother      |
| brother     | Brother     |
| sister      | Sister      |
| uncle       | Uncle       |
| aunt        | Aunt        |
| grandparent | Grandparent |
| other       | Other       |

### EnrollmentStatus

| Value       | Description                  |
| ----------- | ---------------------------- |
| active      | Currently enrolled           |
| withdrawn   | Withdrawn from class         |
| transferred | Transferred to another class |
| promoted    | Promoted to next grade       |

### RoomType

| Value     | Description        |
| --------- | ------------------ |
| classroom | Regular classroom  |
| lab       | Laboratory         |
| hall      | Assembly/exam hall |
| library   | Library            |
| gym       | Gymnasium          |
| office    | Office space       |

### LessonStatus

| Value     | Description             |
| --------- | ----------------------- |
| scheduled | Normal scheduled lesson |
| cancelled | Cancelled lesson        |
| moved     | Moved to different slot |

### LeaveType

| Value     | Description     |
| --------- | --------------- |
| sick      | Sick leave      |
| personal  | Personal leave  |
| maternity | Maternity leave |
| paternity | Paternity leave |
| annual    | Annual leave    |
| unpaid    | Unpaid leave    |
| other     | Other           |

### LeaveStatus

| Value     | Description          |
| --------- | -------------------- |
| pending   | Awaiting approval    |
| approved  | Approved by admin    |
| rejected  | Rejected by admin    |
| cancelled | Cancelled by teacher |

### StudentAttendanceStatus

| Value   | Description          |
| ------- | -------------------- |
| present | Student was present  |
| absent  | Student was absent   |
| late    | Student arrived late |
| excused | Excused absence      |

### TeacherAttendanceStatus

| Value    | Description               |
| -------- | ------------------------- |
| present  | Teacher was present       |
| absent   | Teacher was absent        |
| late     | Teacher arrived late      |
| on_leave | Teacher on approved leave |

### ExamType

| Value      | Description        |
| ---------- | ------------------ |
| quiz       | Short quiz         |
| midterm    | Mid-term exam      |
| final      | Final exam         |
| assignment | Graded assignment  |
| practical  | Practical/lab exam |

### DiscountType

| Value      | Description                   |
| ---------- | ----------------------------- |
| percentage | Percentage discount (max 100) |
| fixed      | Fixed amount discount         |

### InvoiceStatus

| Value          | Description                |
| -------------- | -------------------------- |
| draft          | Not yet issued             |
| issued         | Issued to student/guardian |
| partially_paid | Some payments received     |
| paid           | Fully paid                 |
| overdue        | Past due date              |
| cancelled      | Cancelled                  |

### PaymentMethod

| Value         | Description       |
| ------------- | ----------------- |
| cash          | Cash payment      |
| bank_transfer | Bank transfer     |
| card          | Credit/debit card |
| cheque        | Cheque payment    |
| online        | Online payment    |

### Recurrence

| Value     | Description       |
| --------- | ----------------- |
| monthly   | Monthly recurring |
| quarterly | Every 3 months    |
| term      | Per academic term |
| annual    | Yearly            |

### AnnouncementTargetType

| Value         | Description            |
| ------------- | ---------------------- |
| all           | All users in school    |
| role          | Specific role          |
| grade         | Specific grade level   |
| class_section | Specific class section |

### NotificationChannel

| Value  | Description                 |
| ------ | --------------------------- |
| in_app | In-application notification |
| sms    | SMS message                 |
| email  | Email notification          |
| push   | Push notification           |

### EventType

| Value       | Description          |
| ----------- | -------------------- |
| holiday     | School holiday       |
| exam_period | Examination period   |
| meeting     | Staff/parent meeting |
| activity    | School activity      |
| ceremony    | Ceremony/event       |
| other       | Other event          |

### AuditAction

| Value  | Description    |
| ------ | -------------- |
| INSERT | Record created |
| UPDATE | Record updated |
| DELETE | Record deleted |

---

## Pagination Pattern

All list endpoints use offset-based pagination:

```typescript
// Request query params
{
  page: number; // 1-based, default 1
  limit: number; // default 20, max 100
  sortBy: string; // field name, varies by entity
  order: 'asc' | 'desc';
}

// Response meta
{
  page: number;
  limit: number;
  total: number; // total record count
  totalPages: number; // ceil(total / limit)
}
```

---

## Error Response Format

```typescript
// Operational error
{
  success: false,
  error: {
    code: string,    // machine-readable: "NOT_FOUND", "UNAUTHORIZED", etc.
    message: string  // human-readable description
  }
}

// Validation error (422)
{
  success: false,
  error: {
    code: "VALIDATION_ERROR",
    details: Array<{
      path: string,    // field name
      message: string  // validation message
    }>
  }
}
```

### Common Error Codes

| Code                           | HTTP Status | Description                                        |
| ------------------------------ | ----------- | -------------------------------------------------- |
| UNAUTHORIZED                   | 401         | Missing or invalid JWT                             |
| INVALID_CREDENTIALS            | 401         | Wrong email/password                               |
| INVALID_REFRESH_TOKEN          | 401         | Invalid refresh token                              |
| INVALID_RESET_TOKEN            | 401         | Invalid password reset token                       |
| FORBIDDEN                      | 403         | Insufficient permissions                           |
| ACCOUNT_DISABLED               | 403         | User account deactivated                           |
| SCHOOL_SUSPENDED               | 403         | School is suspended                                |
| SCHOOL_ARCHIVED                | 403         | School is archived                                 |
| SUBSCRIPTION_EXPIRED           | 403         | School subscription expired                        |
| SEED_ROLE_PROTECTED            | 403         | Cannot modify seed roles                           |
| NOT_A_TEACHER                  | 403         | User not linked to a teacher                       |
| NOT_A_STUDENT                  | 403         | User not linked to a student                       |
| NOT_A_GUARDIAN                 | 403         | User not linked to a guardian                      |
| NOT_GUARDIAN_OF_STUDENT        | 403         | Guardian not linked to student                     |
| NOT_FOUND                      | 404         | Resource not found                                 |
| \*\_NOT_FOUND                  | 404         | Specific entity not found (e.g. STUDENT_NOT_FOUND) |
| UNIQUE_VIOLATION               | 409         | Duplicate unique constraint                        |
| ACADEMIC_YEAR_OVERLAP          | 409         | Overlapping academic year dates                    |
| ENROLLMENT_DUPLICATE           | 409         | Student already enrolled in year                   |
| LEAVE_OVERLAP                  | 409         | Overlapping approved leaves                        |
| SCHEDULE_CONFLICT_TEACHER      | 409         | Teacher already has lesson at this time            |
| SCHEDULE_CONFLICT_CLASS        | 409         | Class already has lesson at this time              |
| SCHEDULE_CONFLICT_ROOM         | 409         | Room already occupied at this time                 |
| SUBSTITUTE_ALREADY_ASSIGNED    | 409         | Duplicate substitution for same lesson/date        |
| SUBSTITUTE_HAS_CONFLICT        | 409         | Substitute teacher has schedule conflict           |
| GRADE_IN_USE                   | 409         | Cannot delete grade with dependents                |
| ROLE_IN_USE                    | 409         | Cannot delete role with users                      |
| FK_VIOLATION                   | 400         | Foreign key constraint violation                   |
| INVALID_STATUS_TRANSITION      | 400         | Invalid status change                              |
| INVOICE_NOT_PAYABLE            | 400         | Invoice in non-payable status                      |
| INVOICE_NOT_DRAFT              | 400         | Invoice not in draft status                        |
| CAN_NOT_CANCEL_WITH_PAYMENTS   | 400         | Cannot cancel invoice with payments                |
| LEAVE_NOT_PENDING              | 400         | Leave not in pending status                        |
| LEAVE_ALREADY_STARTED          | 400         | Cannot cancel started leave                        |
| NO_UPDATE_FIELDS               | 400         | No fields provided for update                      |
| EMAIL_CONFLICT                 | 400         | Email already in use                               |
| VALIDATION_ERROR               | 422         | Zod schema validation failed                       |
| DISCOUNT_EXCEEDS_TOTAL         | 422         | Discount larger than invoice total                 |
| OVERPAYMENT                    | 422         | Payment exceeds invoice balance                    |
| SCORE_EXCEEDS_MAX              | 422         | Grade score exceeds max score                      |
| TEACHER_NOT_QUALIFIED          | 422         | Teacher not qualified for subject                  |
| TEACHER_NOT_AVAILABLE          | 422         | Teacher not available at time slot                 |
| ROOM_NOT_SUITABLE              | 422         | Room not suitable for subject                      |
| SUBSTITUTE_IS_ORIGINAL_TEACHER | 422         | Cannot substitute with same teacher                |
| INVALID_PERIOD_OVERLAP         | 422         | Period time ranges overlap                         |
| TERM_OUTSIDE_YEAR              | 422         | Term dates outside academic year                   |
| TERM_OVERLAP                   | 422         | Term dates overlap with another term               |
| INTERNAL_ERROR                 | 500         | Unhandled server error                             |

---

## Status Transition Rules

### Student Status

- `active`  `graduated`, `withdrawn`, `suspended`, `transferred`

### Teacher Status

- `active`  `on_leave`, `resigned`, `terminated`

### School Status

- `active`  `suspended`, `archived`
- `suspended`  `active`, `archived`

### Leave Status

- `pending`  `approved`, `rejected`, `cancelled`

### Invoice Status

- `draft`  `issued` (via issue endpoint)
- `issued`  `partially_paid`, `paid`, `cancelled`
- `partially_paid`  `paid`
- Any payable status  `cancelled` (only if no payments)

---

## Soft Deletes

The following entities use soft deletes (`deletedAt` timestamp):

- **Student** - `DELETE /students/:id` sets `deletedAt`
- **Teacher** - `DELETE /teachers/:id` sets `deletedAt`
- **Guardian** - `DELETE /guardians/:id` sets `deletedAt`

All other entities use hard deletes with cascade protection checks.

---

## Audited Operations

The following operations are automatically logged to the AuditLog table:

- `studentGrade`: create, update, delete
- `feeInvoice`: create, update, delete
- `feePayment`: create, update, delete
- `lesson`: create, update, delete
- `studentEnrollment`: create, update
- `teacherLeave`: update
- `substitution`: create, update, delete
- `user`: update

Each audit log captures: schoolId, userId, tableName, recordId, action, oldValues, newValues, ipAddress, userAgent.

---

## Global Middleware Stack

Applied in order:

1. **Request ID** - UUID generation (`X-Request-Id` header)
2. **Helmet** - CSP, XSS protection headers
3. **CORS** - Configurable origin (`CORS_ORIGIN` env var, default `*`)
4. **Body Parsers** - JSON (1MB limit), URL-encoded
5. **Pino HTTP Logger** - Request/response logging (redacts auth headers and passwords)
6. **Audit Context** - AsyncLocalStorage for userId, schoolId, IP, User-Agent

---

## Environment Variables

| Variable               | Required | Default     | Description                       |
| ---------------------- | -------- | ----------- | --------------------------------- |
| NODE_ENV               | no       | development | development/production/test       |
| PORT                   | no       | 3000        | Server port                       |
| DATABASE_URL           | yes      | -           | PostgreSQL connection string      |
| JWT_SECRET             | yes      | -           | JWT signing secret (min 32 chars) |
| JWT_EXPIRES_IN         | no       | 1h          | Access token expiry               |
| JWT_REFRESH_EXPIRES_IN | no       | 7d          | Refresh token expiry              |
| LOG_LEVEL              | no       | info        | fatal/error/warn/info/debug/trace |
| CORS_ORIGIN            | no       | \*          | Allowed CORS origin               |
